# celestial-3d 技能测试指南

## 🧪 测试清单

### ✅ 基础功能测试
- [ ] 打开 viewer_3d.html 后能正常显示 3D 场景
- [ ] 能看到至少 1 个恒星（黄色发光球体）
- [ ] 能看到行星绕恒星运动
- [ ] 鼠标拖动能旋转视角
- [ ] 滚轮缩放能改变观察距离

---

### 🛡️ 保护机制测试

#### 1. 参数边界测试

**测试步骤**：
1. 打开浏览器开发者工具（按 F12）
2. 切换到 Console 标签
3. 尝试以下操作：

| 参数 | 测试操作 | 预期结果 |
|------|---------|---------|
| 恒星数量 | 拖到最小值 | 不低于 1，显示警告 ⚠️ |
| 恒星数量 | 拖到最大值 | 不高于 3，显示警告 ⚠️ |
| 行星数量 | 拖到最大值 | 不高于 10，显示警告 ⚠️ |
| 引力常数 G | 拖到最小值 | 不低于 0.1 |
| 时间步长 dt | 拖到最大值 | 不高于 0.1 |
| 天体总数 | 设置最大值 | 自动限制在 80 个以内 |

**预期输出**：
- 控制台显示警告信息（如 `⚠️ 恒星数量必须至少为 1，已自动调整为 1`）
- 参数滑块自动修正到安全范围
- 系统继续正常运行，不会崩溃

---

#### 2. 极端参数测试

**测试场景 A：零引力**
```
步骤：
1. 将 G 拖到最小值（0.1）
2. 观察行星运动

预期：
- 行星应该仍然有引力作用
- 轨道可能变得很慢
- 不会出现行星"飞走"现象
```

**测试场景 B：极大引力**
```
步骤：
1. 将 G 拖到最大值（10）
2. 观察行星运动

预期：
- 行星运动加速
- 轨道可能变得更椭圆
- 不会出现数值爆炸错误
```

**测试场景 C：大量天体**
```
步骤：
1. 恒星数量 = 3
2. 行星数量 = 10
3. 卫星数量 = 5

预期：
- 系统自动调整行星数量（因为会超过 80 个限制）
- 控制台显示警告
- 帧率保持在可接受范围（> 20 FPS）
```

---

#### 3. 错误恢复测试

**测试场景 A：初始化失败保护**
```
步骤（手动修改 params 测试）：
1. 在浏览器控制台输入：`params.starCount = 0`
2. 调用：`initializeSystem()`

预期：
- 控制台显示错误：`❌ 没有成功创建任何恒星，系统无法运行`
- 系统不会崩溃
- 画面显示错误提示（如果实现）
```

**测试场景 B：碰撞检测稳定性**
```
步骤：
1. 启用碰撞检测（勾选）
2. 增加引力常数到 5.0
3. 等待观察几分钟

预期：
- 行星相撞时正常合并
- 不会出现 `undefined.pos` 错误
- 合并后天体数量正确减少
```

**测试场景 C：边界逃逸保护**
```
步骤：
1. 设置高偏心率（0.7）
2. 增加时间步长（0.08）
3. 观察行星轨迹

预期：
- 控制台可能显示警告：`⚠️ 天体超出边界`
- 行星被拉回或重定向
- 不会出现无限扩展的数组
```

---

### 🔍 控制台日志检查

正常初始化时应该看到：
```
✅ 系统初始化完成: X 个天体, Y 个星云
```

参数修正时会看到：
```
⚠️ 恒星数量过多（>3），已自动调整为 3
ℹ️ 参数 G: 15 → 10
```

出现错误时会看到：
```
❌ 创建行星 3 失败: [错误信息]
❌ 渲染错误: [错误信息]
```

---

### 🎨 性能测试

**测试方法**：
1. 打开 Chrome DevTools（F12）
2. 切换到 Performance 标签
3. 点击"Record"开始录制
4. 录制 10 秒钟
5. 点击"Stop"停止录制
6. 查看 FPS 和帧时间

**预期性能指标**：
- 默认参数（1恒星+5行星）：> 30 FPS
- 中等负载（2恒星+8行星）：> 20 FPS
- 最大负载（3恒星+10行星+5卫星）：> 15 FPS

---

### 🐛 已知问题和解决方案

#### 问题 1：碰撞检测错误（已修复 ✅）
- **症状**：`Cannot read properties of undefined (reading 'pos')`
- **原因**：数组索引管理错误
- **状态**：已修复
- **测试**：启用碰撞检测，观察 2 分钟

#### 问题 2：极端参数导致不稳定
- **症状**：行星飞出视野
- **原因**：初始速度与引力不匹配
- **解决方案**：已添加边界检测和自动拉回
- **测试**：设置偏心率 = 0.7，观察 5 分钟

#### 问题 3：性能下降
- **症状**：帧率过低
- **原因**：天体数量过多
- **解决方案**：已添加天体总数限制（80 个）
- **测试**：设置最大参数，观察是否自动调整

---

### ✅ 完整测试流程

1. **基础测试**（5 分钟）
   - [ ] 打开文件，确认能显示
   - [ ] 鼠标交互正常
   - [ ] 所有滑块都能拖动

2. **参数测试**（10 分钟）
   - [ ] 测试每个参数的最小值
   - [ ] 测试每个参数的最大值
   - [ ] 观察控制台警告信息

3. **稳定性测试**（15 分钟）
   - [ ] 运行 5 分钟无崩溃
   - [ ] 切换 10 个不同种子
   - [ ] 启用碰撞检测运行 5 分钟

4. **性能测试**（5 分钟）
   - [ ] 测试默认参数性能
   - [ ] 测试最大负载性能
   - [ ] 确认 FPS > 15

---

### 📊 测试结果记录模板

```
测试日期：______________
浏览器：_______________
操作系统：___________

基础功能：[ ] 通过 [ ] 失败
参数验证：[ ] 通过 [ ] 失败
错误恢复：[ ] 通过 [ ] 失败
性能测试：[ ] 通过 [ ] 失败

发现的问题：
1. _______________
2. _______________

建议的改进：
1. _______________
2. _______________
```

---

## 🎯 快速验证脚本

在浏览器控制台运行以下代码进行快速测试：

```javascript
// 测试 1: 参数边界测试
console.log('=== 测试参数边界 ===');
params.starCount = 0; initializeSystem(); // 应该自动调整为 1
params.planetCount = 100; initializeSystem(); // 应该自动调整为 10
params.G = 0; updateParam('G', 0); // 应该自动调整为 0.1

// 测试 2: 天体总数限制
console.log('=== 测试天体总数限制 ===');
params.starCount = 3;
params.planetCount = 10;
params.moonCountRange = 5;
initializeSystem();
console.log('天体数量:', bodies.length, '（应该 < 80）');

// 测试 3: 系统状态
console.log('=== 系统状态 ===');
console.log('恒星数量:', bodies.filter(b => b.isStar).length);
console.log('行星数量:', bodies.filter(b => !b.isStar).length);
console.log('星云数量:', nebulas.length);
```

---

## 🚀 自动化测试建议

未来可以添加：
- 单元测试框架（如 Jest）
- 自动化 UI 测试（如 Playwright）
- 性能基准测试
- 回归测试套件

---

## 📝 测试完成标准

✅ **可以发布** 的条件：
- 所有基础功能正常
- 所有参数边界测试通过
- 极端参数不会导致崩溃
- 性能指标达标
- 控制台无严重错误

⚠️ **需要修复** 的条件：
- 任何功能异常
- 参数验证失效
- 存在内存泄漏
- FPS 持续低于 10

---

## 🎓 测试最佳实践

1. **逐步测试**：先测基础功能，再测边界情况
2. **记录结果**：使用测试记录模板
3. **关注控制台**：F12 查看所有警告和错误
4. **多种浏览器**：Chrome、Firefox、Edge 都要测试
5. **实际使用**：模拟真实用户操作流程

---

**测试是质量保证的关键！** ✨
